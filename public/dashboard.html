<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <!-- لینک صحیح CSS -->
  <link rel="stylesheet" href="css/style.css">
  <!-- فونت Poppins از گوگل -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <a href="index.html" class="logo">BankLogo</a>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="create_account.html">Register</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>

  <!-- داشبورد اصلی -->
  <div class="dashboard-container">
    <div class="welcome">
      <h1 id="welcomeText">Welcome!</h1>
      <p id="dashboardInfo">Here you can manage your demo banking account.</p>
    </div>

    <div class="account-card" id="accountCard">
      <h2>Account Info</h2>
      <p><strong>Username:</strong> <span id="username"></span></p>
      <p><strong>Full Name:</strong> <span id="fullname"></span></p>
      <p><strong>Balance:</strong> $<span id="balance"></span></p>
    </div>
  </div>

  <div class="transfer-box">
    <h2>Transfer Money</h2>
    <input type="text" id="receiver" placeholder="Receiver Username">
    <input type="number" id="amount" placeholder="Amount">
    <button id="transferBtn">Send Money</button>
    <p id="transferMsg"></p>
  </div>

  <div class="transaction-history">
    <h2>Transaction History</h2>
    <table id="transactionTable"></table>
  </div>
  

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (user) {
      document.getElementById("welcomeText").textContent = `Welcome, ${user.first_name}!`;
      document.getElementById("username").textContent = user.username;
      document.getElementById("fullname").textContent = `${user.first_name} ${user.last_name}`;
      document.getElementById("balance").textContent = user.balance.toFixed(2);
    } else {
      window.location.href = "/login.html";
    }
    
    // انتقال پول
    document.getElementById("transferBtn").addEventListener("click", async () => {
      const receiver = document.getElementById("receiver").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);
      const msg = document.getElementById("transferMsg");
    
      if (!receiver || isNaN(amount) || amount <= 0) {
        msg.textContent = "Please enter valid data!";
        msg.style.color = "red";
        return;
      }
    
      try {
        const res = await fetch("/transfer", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ sender: user.username, receiver, amount })
        });
    
        const data = await res.json();
        msg.textContent = data.message;
        msg.style.color = data.success ? "green" : "red";
    
        if(data.success){
          user.balance -= amount;
          localStorage.setItem("user", JSON.stringify(user));
          document.getElementById("balance").textContent = user.balance.toFixed(2);
          loadTransactions(); // بروزرسانی جدول تراکنش‌ها بعد از انتقال
        }
    
      } catch(e){
        msg.textContent = "Server error!";
        msg.style.color = "red";
      }
    });
    
    // لود تاریخچه تراکنش‌ها
    async function loadTransactions() {
      if (!user) return;
    
      try {
        const res = await fetch("/transactions", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ username: user.username })
        });
    
        const transactions = await res.json();
    
        const table = document.getElementById("transactionTable");
        table.innerHTML = `<tr>
          <th>Date</th>
          <th>Sender</th>
          <th>Receiver</th>
          <th>Amount</th>
        </tr>`;
    
        transactions.forEach(t => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${t.date}</td>
            <td>${t.sender}</td>
            <td>${t.receiver}</td>
            <td>$${parseFloat(t.amount).toFixed(2)}</td>
          `;
          table.appendChild(row);
        });
      } catch(e){
        console.error("Failed to load transactions", e);
      }
    }
    
    // لود اولیه
    loadTransactions();
    </script>
    
</body>

</html>