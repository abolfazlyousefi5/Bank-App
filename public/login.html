<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Login</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/gif" href="image/icon.png">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <a href="index.html" class="logo">
      <img src="image/bank-logo.png" alt="Bank Logo" class="bank-logo">
    </a>

    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="create_account.html">Register</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="about.html">About</a></li>
      <li><a href="contact.html">Contact</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>Login to Your Demo Account</h1>
    <form id="loginForm">
      <input type="text" name="card_number" placeholder="Card Number" required>
      <input type="password" name="pin" maxlength="4" placeholder="PIN (4 digits)" required>
      <button type="submit">Login</button>
    </form>

    <p id="loginMessage" style="margin-top:12px;"></p>

    <a href="index.html" class="btn">Back to Home</a>
  </div>

  <script>
    // گرفتن فرم لاگین و المان نمایش پیام
    const loginForm = document.getElementById("loginForm");
    const loginMessage = document.getElementById("loginMessage");
  
    // رویداد ارسال فرم
    loginForm.addEventListener("submit", async function (e) {
      e.preventDefault(); // جلوگیری از رفرش شدن صفحه
  
      // خواندن داده‌های فرم
      const formData = new FormData(loginForm);
      const params = new URLSearchParams();
  
      // تبدیل داده‌های فرم به پارامترهای POST
      for (const pair of formData) {
        params.append(pair[0], pair[1]);
      }
  
      try {
        // ارسال درخواست به سرور برای لاگین
        const res = await fetch("/login", {
          method: "POST",
          body: params
        });
  
        // اگر سرور ارور HTTP برگرداند
        if (!res.ok) {
          loginMessage.innerHTML = "<span style='color:red;'>Login failed! Server returned an error.</span>";
          return;
        }
  
        // تبدیل پاسخ JSON
        const data = await res.json();
  
        // اگر لاگین موفق بود
        if (data.success) {
  
          // ذخیره اطلاعات کامل کاربر در localStorage
          localStorage.setItem("user", JSON.stringify({
            id: data.user.id,
            first_name: data.user.first_name,
            last_name: data.user.last_name,
            card_number: data.user.card_number,
            balance: data.user.balance
          }));
  
          // نمایش پیام خوش‌آمدگویی
          loginMessage.innerHTML =
            `<span style='color:green;'>Welcome ${data.user.first_name} ${data.user.last_name}!<br>Your balance: $${data.user.balance.toFixed(2)}</span>`;
  
          // انتقال به داشبورد
          setTimeout(() => {
            window.location.href = "/dashboard.html";
          }, 1500);
  
        } else {
          // اگر لاگین ناموفق بود (مثلاً PIN اشتباه)
          loginMessage.innerHTML = `<span style='color:red;'>${data.message}</span>`;
        }
  
      } catch (err) {
        // خطای ارتباط با سرور
        console.error(err);
        loginMessage.innerHTML = "<span style='color:red;'>Server error! Check console.</span>";
      }
    });
  </script>
  

</body>

</html>